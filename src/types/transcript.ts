export type ParticipantRole = 'user' | 'moderator' | 'claude' | 'gpt';

export interface TokenUsage {
  totalTokens: number;
  promptTokens: number;
  completionTokens: number;
}

export interface LLMMetrics {
  latencyMs: number;
  retryCount: number;
  firstTokenMs: number;
  tokensPerSecond: number;
  streamDurationMs: number;
}

export interface JsonResponse {
  feedback?: string;
  nextAgent?: string;
  reasoning?: string;
  confidence?: number;
  qualityScore?: number;
  roundNumber?: number;
  isRoundStart?: boolean;
  taskMode?: string;
  debateRound?: number;
  gordonScore?: number;
  catherineScore?: number;
  status?: string;
  isStatusMessage?: boolean;
  totalPageCount?: number;
}

export interface LLMInteraction {
  model: string;
  metrics: LLMMetrics;
  provider: string;
  agentRole: string;
  sessionId: string;
  timestamp: string;
  turnNumber: number;
  request: {
    model: string;
    stream: boolean;
    max_tokens: number;
    temperature?: number;
    messages: Array<{
      role: string;
      content: string;
      _truncated?: boolean;
      _originalLength?: number;
    }>;
    rawBody?: Record<string, unknown>;
    system?: string;
    _systemTruncated?: boolean;
    _systemOriginalLength?: number;
  };
  response: {
    model: string;
    content: string;
    usage: {
      total_tokens: number;
      prompt_tokens: number;
      completion_tokens: number;
    };
    rawBody?: Record<string, unknown>;
    stop_reason?: string;
    _contentTruncated?: boolean;
    _contentOriginalLength?: number;
  };
}

export interface MessageMetadata {
  // Basic info
  model?: string;
  usage?: TokenUsage;
  turn?: number;
  timestamp?: string;
  
  // LLM details
  llm_model?: string;
  llm_provider?: string;
  llm_latency_ms?: number;
  llm_tokens_used?: number;
  llmInteraction?: LLMInteraction;
  
  // Response parsing
  jsonResponse?: JsonResponse;
  parsedFeedback?: string;
  
  // Message metadata
  duration?: number;
  messageId?: string;
  stopReason?: string;
  chunkCount?: number;
  
  // Planning and generation
  planningType?: string;
  autoGenerated?: boolean;
  runId?: string;
  eventType?: string;
  
  // Document generation
  totalPageCount?: number;
  modelUsed?: string;
  requestId?: string;
  generatedAt?: string;
  totalChunks?: number;
  totalTokens?: number;
  documentType?: string;
  targetLength?: string;
  documentTitle?: string;
  estimatedWords?: number;
  targetPageCount?: number;
  isGeneratedDocument?: boolean;
  
  // Session end
  reason?: string;
  moderatorFeedback?: string;
  endReason?: string;
  totalTurns?: number;
  totalUsage?: TokenUsage;
  
  // Other
  isDocumentChoice?: boolean;
  error?: string;
  
  // Allow additional fields
  [key: string]: unknown;
}

export interface TranscriptMessage {
  role: ParticipantRole;
  content: string;
  timestamp: string;
  metadata: MessageMetadata;
}

export interface ParsedContent {
  displayContent: string;
  isJson: boolean;
  originalContent: string;
  clarificationQuestions?: string[];
  feedback?: string;
  taskMode?: string;
  nextAgent?: string;
}

export interface ParticipantInfo {
  role: ParticipantRole;
  name: string;
  description: string;
  color: string;
  bgColor: string;
  borderColor: string;
  avatarBg: string;
  icon: string;
}

export const PARTICIPANT_CONFIG: Record<ParticipantRole, ParticipantInfo> = {
  user: {
    role: 'user',
    name: 'User',
    description: 'Human participant',
    color: 'text-emerald-600',
    bgColor: 'bg-emerald-50',
    borderColor: 'border-emerald-200',
    avatarBg: 'bg-emerald-500',
    icon: 'üë§',
  },
  moderator: {
    role: 'moderator',
    name: 'Maude',
    description: 'Debate Moderator',
    color: 'text-amber-600',
    bgColor: 'bg-amber-50',
    borderColor: 'border-amber-200',
    avatarBg: 'bg-amber-500',
    icon: '‚öñÔ∏è',
  },
  claude: {
    role: 'claude',
    name: 'Catherine',
    description: 'Claude Agent',
    color: 'text-violet-600',
    bgColor: 'bg-violet-50',
    borderColor: 'border-violet-200',
    avatarBg: 'bg-violet-500',
    icon: 'ü§ñ',
  },
  gpt: {
    role: 'gpt',
    name: 'Gordon',
    description: 'GPT Agent',
    color: 'text-sky-600',
    bgColor: 'bg-sky-50',
    borderColor: 'border-sky-200',
    avatarBg: 'bg-sky-500',
    icon: 'üß†',
  },
};

// Helper to get task mode display
export function getTaskModeDisplay(mode?: string): { label: string; color: string } | null {
  if (!mode) return null;
  
  const modes: Record<string, { label: string; color: string }> = {
    solve: { label: 'Solve', color: 'text-green-400 border-green-700 bg-green-950/50' },
    analyze: { label: 'Analyze', color: 'text-blue-400 border-blue-700 bg-blue-950/50' },
    brainstorm: { label: 'Brainstorm', color: 'text-purple-400 border-purple-700 bg-purple-950/50' },
    debate: { label: 'Debate', color: 'text-orange-400 border-orange-700 bg-orange-950/50' },
  };
  
  return modes[mode.toLowerCase()] || { label: mode, color: 'text-zinc-400 border-zinc-700 bg-zinc-900' };
}

// Helper to format duration
export function formatDuration(ms?: number): string | null {
  if (!ms) return null;
  if (ms < 1000) return `${ms}ms`;
  if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`;
  const minutes = Math.floor(ms / 60000);
  const seconds = Math.floor((ms % 60000) / 1000);
  return `${minutes}m ${seconds}s`;
}
